#{extends 'main.html' /} 
#{set title:'Carte opendata' /}

#{set 'moreStyles' }
    <link rel="stylesheet" href="http://openlayers.org/api/theme/default/style.css" type="text/css" />
    
#{/set}
#{set 'moreScripts'}
    <script src="http://openlayers.org/api/OpenLayers.js"></script>
    <script type="text/javascript">
        var map;
        var pureCoverage = false;
        var format = 'image/png';
        // pink tile avoidance
        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 5;
        // make OL compute scale according to WMS spec
        OpenLayers.DOTS_PER_INCH = 25.4 / 0.28;
    
        function init() {
        	// Map is in mercator this time, so over-ride the default
        	// options that assume lat/lon.
        	var bounds = new OpenLayers.Bounds(
                    -180, -76.164,
                    180, 83.634
            );
        	var options = {
                controls: [],
                minScale: 20,
                maxScale: 800,
                maxExtent: bounds,
                maxResolution: 1.40625,
                projection: new OpenLayers.Projection("EPSG:900913"),
                units: 'm'
            };
          	// Create the map object
          	map = new OpenLayers.Map('map', options);
          	// Create a OSM layer
          	//var osm = new OpenLayers.Layer.OSM();
          	var countries = new OpenLayers.Layer.WMS(
                    "Countries",
                    "${wmsurl}", 
                    {
                    	'layers': 'libertic:country', 
                    	'format':format, 
                    	'transparent':'true',
                    	'tiled': !pureCoverage,
                        'tilesOrigin' : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                    	'singleTile': true,
                    	'ratio': 1,
                    	'opacity': 1.0, 
                    	'isBaseLayer': true, 
                    	'visibility': true
                    }
            );
          	var libertic_country = new OpenLayers.Layer.WMS(
                    "Countries",
                    "${wmsurl}", 
                    {
                    	'layers': 'libertic_country', 
                    	'format':format, 
                    	'transparent':'true',
                    	'tiled': !pureCoverage,
                        'tilesOrigin' : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                    	'singleTile': true,
                    	'ratio': 1,
                    	'buffer': 0,
                        'displayOutsideMaxExtent': true, 
                    	'isBaseLayer': false, 
                    	'visibility': true,
                    	'units': 'm',
                    	'maxResolution': "auto",
                    	'minScale': 801,
                        'maxScale': 300
                    }
            );
          	var libertic_zone1 = new OpenLayers.Layer.WMS(
                    "Administrative Zone level 1",
                    "${wmsurl}", 
                    {
                    	'layers': 'libertic_zone1', 
                    	'format':format,
                    	'transparent':'true',
                    	'tiled': !pureCoverage,
                        'tilesOrigin' : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                    	'singleTile': true,
                    	'ratio': 1,
                    	'opacity': 1.0, 
                    	'isBaseLayer': false, 
                    	'visibility': true,
                    	'minScale': 300,
                        'maxScale': 19
                    }
            );
          	var libertic_zone2 = new OpenLayers.Layer.WMS(
                    "Administrative Zone level 2",
                    "${wmsurl}", 
                    {
                    	'layers': 'libertic_zone2', 
                    	'format':format, 
                    	'transparent':'true',
                    	'tiled': !pureCoverage,
                        'tilesOrigin' : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                    	'singleTile': true,
                    	'ratio': 1,
                    	'opacity': 1.0, 
                    	'isBaseLayer': false, 
                    	'visibility': true,
                    	'minScale': 150,
                        'maxScale': 19
                    }
            );
          	var libertic_city = new OpenLayers.Layer.WMS(
                    "Cities",
                    "${wmsurl}", 
                    {
                    	'layers': 'libertic_city', 
                    	'format':format,
                    	'transparent':'true',
                    	'tiled': !pureCoverage,
                        'tilesOrigin' : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                    	'singleTile': true,
                    	'ratio': 1,
                    	'opacity': 1.0, 
                    	'isBaseLayer': false, 
                    	'visibility': true,
                    	'minScale': 100,
                        'maxScale': 19
                    }
            );
          	// Add layer to map
          	map.addLayers([countries, libertic_country, libertic_zone1, libertic_zone2, libertic_city]);
         	// build up all controls
            map.addControl(new OpenLayers.Control.PanZoomBar({
                position: new OpenLayers.Pixel(2, 15)
            }));
            map.addControl(new OpenLayers.Control.Navigation());
            map.addControl(new OpenLayers.Control.Scale('#scale'));
            map.zoomToExtent(bounds);
          	
          	
            if (navigator.geolocation)
            {
              navigator.geolocation.getCurrentPosition(function(position)
              {
            	  map.setCenter(new OpenLayers.LonLat(position.coords.longitude,  position.coords.latitude), 6);
              });
            }
            else
            {
          		map.setCenter(new OpenLayers.LonLat(2.46,  47.18), 6);
            }
        }
        
        $(document).ready(function(){
        	init();
        });
    </script>
#{/set}


<div class="row">
    <div class="span12">
        <div id="map" class="smallmap"></div>
        <p>
            <strong>&{'page.home.legende'}: </strong>
            <span class="legende" style="background-color:#BEE669">&nbsp;&nbsp;&nbsp;&nbsp;</span> &{'page.home.legende.ok'}
            <span class="legende" style="background-color:#89C0DE">&nbsp;&nbsp;&nbsp;&nbsp;</span> &{'page.home.legende.inprogress'}
            <span class="legende" style="background-color:#B5B3B4">&nbsp;&nbsp;&nbsp;&nbsp;</span> &{'page.home.legende.thinking'}
            <span class="legende" style="background-color:red">&nbsp;&nbsp;&nbsp;&nbsp;</span> &{'page.home.legende.citizenMvt'}
           
    </div>
    <div class="span2">
    </div>
</div>
